<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}">

<head layout:fragment="head">
    <link href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css" rel="stylesheet" />

    <style>
        .card-body img {
            width: 50%;
            max-width: 50%;
            height: auto;
            object-fit: contain;
        }

        .card-text img {
            width: 100%;
            max-width: 70%;
            height: auto;
            object-fit: contain;
            display: block;
            margin: 0;
            padding: 0;
            text-align: left;
        }

        .card-body p, .card-body textarea {
            display: block;
            width: 100%;
        }

        .like-button {
            background: none;
            border: none;
            padding: 0;
            font-size: 1.2rem;
            cursor: pointer;
        }


         #commentList .list-group-item {
             border: none;
         }

        .icon-button {
            padding: 4px 4px;
            font-size: 12px;
            line-height: 1;
            background: #f0f0f0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .icon-button:hover {
            background-color: lightgray; /* ë°ì€ íšŒìƒ‰ hover íš¨ê³¼ */
            border-radius: 4px;
        }

        .icon-button:focus {
            outline: none;
            box-shadow: none;
        }
        .custom-orange-btn {
            background-color: #f57c00;
            color: white;
            border: none;
        }

        .custom-orange-btn:hover {
            background-color: #e65100; /* ì¡°ê¸ˆ ë” ì§„í•œ ì˜¤ë Œì§€ */
            color: white;
        }

    </style>
</head>

<section layout:fragment="main">
    <div class="row mt-0">
        <!-- ì‚¬ì´ë“œë°” -->
        <div th:replace="~{fragments/sidebar :: sidebarFragment}"></div>

        <!-- ë³¸ë¬¸ -->
        <div class="col-md-9 pt-4 bg-white">
            <div class="d-flex justify-content-between ml-4">
                <h6 class="text-left mb-4 mt-5 fs-6">ğŸ’¬ì†Œí†µê²Œì‹œíŒ</h6>
                <div class="text-center mt-5 pt-2 mr-2">
                    <a th:if="${isowner}" th:href="@{/post/new(id=${post.id})}" class="btn btn-secondary text-white me-2 mr-1 btn-sm">ìˆ˜ì •</a>
                    <button th:if="${isowner}" class="btn btn-secondary btn-sm" id="deletePostBtn" th:attr="data-post-id=${post.id}">ì‚­ì œ</button>
                    <button th:if="${isowner}" class="btn btn-primary btn-sm d-none" id="savePostBtn">ì €ì¥</button>
                </div>
            </div>

            <div class="container my-5 col-lg-12 ml-2 mr-4">
                <div class="card shadow-sm">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="fw-bold fs-4" th:text="${post.title}" id="postTitleText"></span>
                            <a th:href="@{/note/new(id=${post.author.username})}" th:if="${post.author.id != loggedInUserId}"
                                   class="btn btn-outline-secondary btn-sm text-end me-3 ml-2 mail-icon-btn" title="ìª½ì§€ ë³´ë‚´ê¸°">
                                <i class="bi bi-envelope"></i>
                            </a>
                        </div>
                        <label for="postTitleInput" class="d-none">ê²Œì‹œê¸€ ì œëª©</label>
                        <input type="text" class="form-control d-none" id="postTitleInput" value="[[${post.title}]]" />
                        <p class="my-0 mt-2 mb-0"><small th:text="${post.author.nickname}" style="font-size: 0.85em; color: gray;" class="pr-0">ë‹‰ë„¤ì„(ë“±ê¸‰ 2)</small>
                            <span th:switch="${post.author.levelNumber}">
                                                <small th:case="1">ğŸ¥‰</small>
                                                <small th:case="2">ğŸ¥ˆ</small>
                                                <small th:case="3">ğŸ¥‡</small>
                                            </span></p>
                        <p class="my-0"><small th:text="${#temporals.format(post.createdAt, 'yyyy-MM-dd HH:mm')}"
                                                   style="font-size: 0.85em; color: gray;">ì‘ì„±ì¼</small></p>
                    </div>



                    <div class="card-body">
                        <div class="card-text" th:utext="${post.content}" id="postContentText"></div>
                        <label for="postContentInput" class="d-none">ë³¸ë¬¸ ë‚´ìš©</label>
                        <textarea class="form-control d-none" id="postContentInput">[[${post.content}]]</textarea>

                        <!-- ì¢‹ì•„ìš” ë²„íŠ¼ ê´€ë ¨-->
                        <div class="mt-3">
                            <button id="like-btn" class="like-button" th:data-post-id="${post.id}">ğŸ‘</button>
                            <span id="like-count" th:text="${post.likes}">0</span>
                        </div>
                    </div>

                    <div th:if="${post.imgUrls != null and not #lists.isEmpty(post.imgUrls)}" class="mt-4">
                        <div class="row g-3">
                            <div class="col-md-6" th:each="imgUrl : ${post.imgUrls}">
                                <img th:src="${imgUrl}" class="img-fluid rounded border" alt="Post Image">
                            </div>
                        </div>
                    </div>
                </div>
                <a href="/post" class="btn btn-dark btn-sm shadow-sm mt-4">ëª©ë¡</a>
            </div>

            <div class="col-lg-12 ml-2 mr-4 px-0" id="postContainer" th:attr="data-post-id=${post.id}">
                <h6 class="ml-3">ëŒ“ê¸€</h6>
                <ul class="list-group mx-0" id="commentList" style="border: none;">
                    <!--/* @thymesVar id="comment" type="com.est.runtime.comment.dto.CommentResponse" */-->
                    <li class="list-group-item ml-0" th:each="comment : ${comments.content}">
                        <div class="card px-4 mb-1" style="position: relative; border: none; border-bottom: 1px solid #dee2e6;">
                            <div class="d-flex align-items-center">
                            <div class="d-flex align-items-center flex-grow-1">
                                <small th:text="${comment.author.nickname}" class="fw-medium mr-1">ë‹‰ë„¤ì„</small>
                                <span th:switch="${comment.author.levelNumber}">
                                    <small th:case="1">ğŸ¥‰</small>
                                    <small th:case="2">ğŸ¥ˆ</small>
                                    <small th:case="3">ğŸ¥‡</small>
                                </span>
                            </div>
                                <!-- ìˆ˜ì • ë° ì‚­ì œ ë²„íŠ¼ì„ ì˜¤ë¥¸ìª½ ëì— ë°°ì¹˜ -->
                                <div class="ms-auto">
                                    <a class="btn btn-sm icon-button me-1" th:href="@{/note/new(id=${comment.author.username})}"  th:if="${comment.author.id != loggedInUserId}">âœ‰ï¸</a>
                                    <button class="icon-button editCommentBtn me-1" th:attr="data-comment-id=${comment.commentId}" th:if="${comment.author.id == loggedInUserId}">âœï¸</button>
                                    <button class="icon-button deleteCommentBtn" th:attr="data-comment-id=${comment.commentId}" th:if="${comment.author.id == loggedInUserId or isowner}">âŒ</button>
                                    <button class="icon-button saveEditBtn d-none mt-1" th:attr="data-comment-id=${comment.commentId}" th:if="${comment.author.id == loggedInUserId}">âœ…</button>
                                </div>
                            </div>

                            <textarea class="form-control d-none" th:id="'edit-comment-body-' + ${comment.commentId}">[[${comment.body}]]</textarea>
                            <span th:id="'comment-body-' + ${comment.commentId}" th:text="${comment.body}" style="color: dimgrey">ëŒ“ê¸€ ë‚´ìš©</span>
                        </div>

                        <p class="mb-1">
                            <small th:text="${#temporals.format(comment.createdAt, 'yyyy-MM-dd HH:mm')}" style="font-size: 0.85em; color: gray;">ì‘ì„±ì¼</small>
                            <span class="showReplyFormText" th:data-comment-id="${comment.commentId}" style="margin-left: 8px; cursor: pointer; color: #0d6efd; font-size: 0.7rem;"
                                  onmouseover="this.style.textDecoration='underline'"
                                  onmouseout="this.style.textDecoration='none'">ëŒ€ëŒ“ê¸€ì“°ê¸°</span>
                        </p>

                        <ul class="list-group replies ms-3 pr-0 pb-0">
                            <li class="list-group-item ml-4 pb-0 pr-0 mr-0 pt-0" th:each="reply : ${comment.replies}">â¤·
                                <div class="card px-4 mb-1 mr-0 pb-0" style="position: relative; border: none; border-bottom: 1px solid #ccc;">
                                    <div class="d-flex align-items-center">
                                        <div class="d-flex align-items-center flex-grow-1">
                                            <small th:text="${reply.author.nickname}" class="fw-medium mr-1">ë‹‰ë„¤ì„</small>
                                            <span th:switch="${reply.author.levelNumber}">
                                                <small th:case="1">ğŸ¥‰</small>
                                                <small th:case="2">ğŸ¥ˆ</small>
                                                <small th:case="3">ğŸ¥‡</small>
                                            </span>
                                        </div>
                                        <div class="ms-auto">
                                            <a class="btn btn-sm icon-button me-1" th:href="@{/note/new(id=${reply.author.username})}" th:if="${reply.author.id != loggedInUserId}">âœ‰ï¸</a>
                                            <button class="btn btn-sm icon-button editReplyBtn me-1"
                                                    th:attr="data-reply-id=${reply.commentId}" th:if="${reply.author.id == loggedInUserId}">âœï¸</button>
                                            <button class="btn btn-sm icon-button deleteReplyBtn"
                                                    th:attr="data-reply-id=${reply.commentId}" th:if="${reply.author.id == loggedInUserId or isowner}">âŒ</button>
                                            <button class="btn btn-sm icon-button saveEditReplyBtn d-none"
                                                    th:attr="data-reply-id=${reply.commentId}" th:if="${reply.author.id == loggedInUserId}">âœ…</button>
                                        </div>
                                    </div>

                                    <textarea class="form-control d-none ml-2" th:id="'edit-reply-body-' + ${reply.commentId}">[[${reply.body}]]</textarea>
                                    <p th:id="'reply-body-' + ${reply.commentId}" th:text="${reply.body}" class="mb-0" style="color: dimgrey">ëŒ€ëŒ“ê¸€ ë‚´ìš©</p>
                                </div>
                                <div class="text-end">
                                    <small th:text="${#temporals.format(reply.createdAt, 'yyyy-MM-dd HH:mm')}" style="font-size: 0.8em; color: gray;">ì‘ì„±ì¼</small>
                                </div>
                            </li>
                        </ul>
                        <div class="replyFormContainer ml-4 mt-2 ms-2 d-none" th:attr="data-parent-id=${comment.commentId}">
                            <form class="replyForm ml-3" th:attr="data-parent-id=${comment.commentId}">
                                <div class="mb-1">
                                    <textarea class="form-control replyBody" rows="1" style="font-size: 0.8em;" placeholder="ë‹µê¸€ì„ ì‘ì„±í•´ì£¼ì„¸ìš”..." required></textarea>
                                </div>
                                <div class="d-flex">
                                    <button type="submit" class="btn btn-sm shadow mr-1 custom-orange-btn">ë“±ë¡</button>
                                    <button type="button" class="btn btn-sm btn-secondary cancelReplyBtn" th:attr="data-parent-id=${comment.commentId}">ì·¨ì†Œ</button>
                                </div>
                            </form>
                        </div>
                    </li>
                </ul>

                <form id="commentForm" class="col-lg-12 ml-0 mr-5 mt-2">
                    <div class="mb-3 mx-0 mr-1">
                        <textarea class="form-control" id="commentBody" name="body" rows="1" style="font-size: 0.8em;" placeholder="ëŒ“ê¸€ì„ ì‘ì„±í•´ì£¼ì„¸ìš”..." required></textarea>
                    </div>
                    <button type="submit" class="btn btn-sm shadow custom-orange-btn">ëŒ“ê¸€ë“±ë¡</button>
                </form>
            </div>
        </div>
    </div>

    <script src="/js/like.js"></script>
                <!-- í˜ì´ì§€ë„¤ì´ì…˜ ë²„íŠ¼ -->
                <div class="mt-3 d-flex justify-content-between">
                    <a th:if="${comments.hasPrevious()}"
                       th:href="@{/post/{id}(id=${post.id}, page=${comments.number - 1})}"
                       class="btn btn-outline-primary btn-sm">ì´ì „</a>

                    <a th:if="${comments.hasNext()}"
                       th:href="@{/post/{id}(id=${post.id}, page=${comments.number + 1})}"
                       class="btn btn-outline-primary btn-sm ml-auto">ë‹¤ìŒ</a>
                </div>
            </div>
        </div>
    <script src="/js/post.js"></script>
    <script src="/js/comment.js"></script>
</section>
</html>